\documentclass[12pt,a4paper]{article}
\usepackage{polski}
\usepackage[cp1250]{inputenc}
\usepackage{graphicx}
\usepackage{float}
\usepackage{multirow}
\usepackage{hyperref}
\graphicspath{ {./img/} }

\begin{document}
\section{Wersje konsol}
Pierwotnym wydaniem konsoli by³ Family Computer z 1983 roku, w skróconej formie nazywany "Famicom". Famicom oficjalnie nigdy nie zosta³ wydany poza Japoni¹.
Nintendo przygotowuj¹c siê do wydania miêdzynarodowego swojej konsoli do grania podjê³o decyzjê o przeprojektowaniu wygl¹du sprzêtu w celu dostosowania siê do zachodnich odbiorców. Wynikiem tych prac by³ Nintendo Entertainment System, wydany w 1985 roku w USA, rok póŸniej na terenie Europy oraz w 1987 roku w pozosta³ych lokalizacjach w Europie oraz Australii\cite{wikiNES}.
\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{Nintendo-Famicom-Console-Set-FL}
\caption{Family Computer wraz z kontrolerami\cite{IMG-NintendoFamicomConsoleSetFL}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{NES-Console-Set}
\caption{Nintendo Entertainment System NES-001 wraz z kontrolerem\cite{IMG-NESConsoleSet}}
\end{minipage}%
\end{figure}

Odœwie¿one wersje konsol zosta³y wydane w 1993 roku. Nintendo znacznie zunifikowa³o wygl¹d zewnêtrzny konsol, zachowuj¹c kompatybilnoœæ kartrid¿y dla poszczególnych regionów.
\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{New_Famicom}
\caption{"New Famicom" wraz z kontrolerem\cite{IMG-NewFamicom}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{NES-101-Console-Set}
\caption{Nintendo Entertainment System NES-101 wraz z kontrolerem\cite{IMG-NES101ConsoleSet}}
\end{minipage}%
\end{figure}

Obok oryginalnych sprzêtów od Nintendo równoczeœnie egzystowa³y konsole podrabiane na masow¹ skalê, w wiêkszoœci by³y to produkty kompatybilne z japoñskim Famicomem. Dok³adna historia nie jest znana; zebrane informacje pozwalaj¹ na stwierdzenie, i¿ pierwsze podróbki zaczê³y pojawiaæ siê pod koniec lat osiemdziesi¹tych oraz zosta³y wyprodukowane na Tajwanie. W latach dziewiêædziesi¹tych nastêpowa³a miniutaryzacja sprzêtów oraz minimalizacja kosztów, co spowodowa³o stopniowo powiêkszane przenoszenie produkcji do Chin oraz drastyczny spadek jakoœci wykonania konsol.
Kreatywnoœæ "piratów" doprowadzi³a do powstania sprzêtów bêd¹cych czymœ innym ni¿ zwyczajna konsola:
\begin{itemize}
  \item Konsole z dwoma gniazdami na kartrid¿e - jedno dla gier z Famicoma, drugie dla gier z NES,
  \item Konsole z dwoma gniazdami na kartrid¿e - jedno standardowo na zewn¹trz obudowy, drugie wewn¹trz obudowy z fabrycznie zamontowan¹ gr¹. Dziêki temu rozwi¹zaniu gdy w zewnêtrznym gnieŸdzie nie by³o zamontowanego kartrid¿a to uruchamia³ siê kartrid¿ wbudowany w konsolê,
  \item Konsola-klawiatura, udaj¹ca komputer - zawsze do³¹czano kartrid¿ z "programami multimedialnymi" które korzysta³y z klawiatury. By³a tu pewna inspiracja oficjalnym Family Basic,
  \item Przenoœna konsola z wbudowanym wyœwietlaczem,
  \item Sprzêty "Plug 'n' Play" o wymyœlnych kszta³tach, czêsto by³y one pozbawione gniazda na kartrid¿e, zatem wbudowane gry musia³y wystarczyæ.
\end{itemize}
\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{415J8GUp-KL--52577.1589699928}
\caption{Generation NEX - klon z dwoma gniazdami na kartrid¿e, górne jest dla gier Famicom, boczne dla gier NES\cite{IMG-GenerationNEX}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{DY-656-400}
\caption{Daryar DY-400-656 - konsola z wbudowan¹ gr¹ 400 in 1\cite{IMG-DaryarDY400656}}
\end{minipage}%
\end{figure}

\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{glk_2004}
\caption{GLK-2004 - popularna konsola-klawiatura\cite{IMG-GLK-2004}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{gameaxe_1}
\caption{Game Axe Color - jeden z pierwszych handheldów (2000 rok) odtwarzaj¹cy gry z Famicoma\cite{IMG-Game-Axe-Color}}
\end{minipage}%
\end{figure}


Klony konsoli Nintendo s¹ produkowane po dzieñ dzisiejszy, tyle ¿e czêœciowo wysz³y ze szarej strefy - "Wielkie N" nie ma podstaw prawnych do s¹dzenia siê z firmami gdy¿ wygas³y patenty (TODO: sprawdziæ dok³adnie jak to wygl¹da, lecê z g³owy z tego co kiedyœ czyta³em). Konstrukcje s¹ równie¿ uwspó³czeœniane poprzez zastosowanie gniazd HDMI czy obs³ugê gier z kilku platform jednoczeœnie.
\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{RetroUSB-AVS-Console-wController-FL}
\caption{RetroUSB AVS - konsola wysokiej jakoœci do której stworzenia u¿yto podzespo³ów z oryginalnych NES\cite{IMG-RetroUSBAVS}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{ret5bk--54484.1567795736.1280.1280}
\caption{Hyperkin RetroN 5 - sprzêt obs³uguj¹cy ogromn¹ iloœæ platform jednoczeœnie, równie¿ kartrid¿e do NES i Famicoma\cite{IMG-RetroN5}}
\end{minipage}%
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{61iW8vUHOJL.-AC-SL1500-}
\caption{NES 620 Games - niskobud¿etowy, wspó³czesny klon konsoli NES z wbudowanymi grami, bez zewnêtrznego gniazda na kartrid¿e\cite{IMG-620Games}}
\end{minipage}%
\end{figure}

Nieoficjalne sprzêty zyska³y popularnoœæ w biedniejszych krajach w których Nintendo nie dystrybuowa³o swoich produktów. "Marki" konsol ró¿ni³y siê miêdzy poszczególnymi pañstwami, niektóre kraje mia³y nawet "oficjalnych dystrybutorów tych¿e podróbek. Mia³y równie¿ miejsce sytuacje, gdzie jeden i ten sam model / typ konsoli by³ sprzedawany pod kilkoma nazwami.\cite{wikiNESClones}

\begin{figure}[htp]
\centering
\includegraphics[width=.5\textwidth]{img/iq502.jpg}
\caption{Micro Genius IQ-502 - wersja konsoli sygnowana mark¹ producenta\cite{IMG-mgiq502}}
\label{fig:figure3}
\end{figure}

\begin{figure}[H]
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{pegiq502}
\caption{Pegasus IQ-502 - wersja Micro Genius IQ-502 przeznaczona na rynek polski, Pegasus to marka firmy Bobmark.\cite{IMG-pegiq502}}
\end{minipage}
\hfill
\begin{minipage}[c]{0.5\linewidth}
\includegraphics[width=\textwidth]{5b6c9ad96c86cb85b53b41c2}
\caption{Dendy Classic 2 - wersja konsoli Micro Genius IQ-502 przeznaczona na rynek rosyjski, Dendy to marka firmy Steepler.\cite{IMG-deniq502}}
\end{minipage}%
\end{figure}
Wszystkie trzy powy¿sze sprzêty to w rzeczywistoœci jeden projekt firmy Micro Genius, ró¿ni¹cy siê logotypami na konsoli oraz padach.

\section{Specyfikacja konsoli}
Procesor (CPU): Ricoh 2A03 (NTSC) / Ricoh 2A07 (PAL), oœmiobitowy mikroprocesor bêd¹cy modyfikacj¹ MOS 6502. Ró¿nice 2A03 / 2A07 wzglêdem produktu MOS Technology s¹ nastêpuj¹ce\cite{nesdoc}:
\begin{itemize}
  \item Deaktywowany tryb dziesiêtny (BCD),
  \item Wbudowany generator dŸwiêkowy,
  \item Obs³uga kontrolerów poprzez porty \$4016 oraz \$4017,
  \item DMA.
\end{itemize}
Mimo i¿ jest to 8-bitowy procesor, mo¿na zaadresowaæ 64 kilobajty pamiêci.
To, jak podzielona jest ta przestrzeñ adresowa przedstawia poni¿sza tabela (podane wartoœci s¹ zapisane w systemie szesnastkowym):
\begin{table}[H]
\begin{tabular}{|l|l|l|}
\hline
Adresy & Rozmiar & Zastosowanie \\
\hline
{\$}0000 - {\$}07FF & {\$}0800 & Wewnêtrzna pamiêæ RAM (dwa kilobajty) \\ \hline
{\$}0800 - {\$}1FFF & {\$}0800 & Duble danych spod adresów {\$}0000 - {\$}07FF (co dwa kilobajty) \\ \hline
{\$}2000 - {\$}2007 & {\$}0008 & Rejestry kontroluj¹ce PPU \\ \hline
{\$}2008 - {\$}3FFF & {\$}1FF8 & Duble danych spod adresów {\$}2000 - {\$}2007 (co osiem bajtów)\\ \hline
{\$}4000 - {\$}4017 & {\$}0018 & Rejestry kontroluj¹ce APU oraz rejestry wejœcia / wyjœcia\\ \hline
{\$}4018 - {\$}401F & {\$}0008 & Dezaktywowany tryb samotestowania \\ \hline
{\$}4020 - {\$}FFFF & {\$}BFE0 & Przestrzeñ do dowolnej dyspozycji dla kartrid¿a \\ \hline 
\end{tabular}
\end{table}
Adresy {\$}4020 - {\$}FFFF s¹ zaadresowane zgodnie z mo¿liwoœciami kartrid¿a (patrz \nameref{mapper}) \cite{nesmemorymap}

Uk³ad graficzny (PPU): Ricoh 2C02, oœmiobitowy uk³ad opracowany przez Nintendo specjalnie dla tej konsoli. Mimo i¿ jest to 8-bitowy procesor, mo¿na zaadresowaæ 16 kilobajtów pamiêci. To, jak podzielona jest ta przestrzeñ adresowa przedstawia poni¿sza tabela (podane wartoœci s¹ zapisane w systemie szesnastkowym):
\begin{table}[H]
\begin{tabular}{|l|l|l|} \hline
Adresy & Rozmiar & Zastosowanie \\ \hline
{\$}0000 - {\$}0FFF & {\$}1000 & \nameref{patterntable} 0 \\ \hline
{\$}1000 - {\$}1FFF & {\$}1000 & \nameref{patterntable} 1 \\ \hline
{\$}2000 - {\$}23FF & {\$}0400 & \nameref{nametable} 0 \\ \hline
{\$}2400 - {\$}27FF & {\$}0400 & \nameref{nametable} 1 \\ \hline
{\$}2800 - {\$}2BFF & {\$}0400 & \nameref{nametable} 2 \\ \hline
{\$}2C00 - {\$}2FFF & {\$}0400 & \nameref{nametable} 3 \\ \hline
{\$}3000 - {\$}3EFF & {\$}0F00 & Dubel danych spod adresów {\$}2000 - {\$}2EFF \\ \hline 
{\$}3F00 - {\$}3F1F & {\$}0020 & \nameref{palette} \\ \hline 
{\$}3F20 - {\$}3FFF & {\$}00E0 & Duble palety barw (co 32 bajty) \\ \hline 
\end{tabular}
\end{table}
Dostêp do wy¿ej wymienionych adresów odbywa siê poprzez adresy CPU: {\$}2006 i {\$}2007.
Gniazdo kartrid¿y: 60-pin (Famicom), 72-pin (NES)

\subsection{Rejestry kontroluj¹ce PPU}
\label{cpuppuregisters}
Adresy {\$}2000 - {\$}2007 oraz {\$}4014 w CPU maj¹ specjalne znaczenie - poprzez nie programista / program mo¿e wp³yn¹æ na dzia³anie uk³adu graficznego konsoli. Zwyczajowe nazwy tych adresów przedstawia poni¿sza tabela \cite{wikicpuppuregisters}:
\begin{table}[H]
\begin{tabular}{|l|l|} \hline
Adres {hex} & Nazwa \\ \hline
{\$}2000 & PPUCTRL \\ \hline
{\$}2001 & PPUMASK \\ \hline
{\$}2002 & PPUSTATUS \\ \hline
{\$}2003 & OAMADDR \\ \hline
{\$}2004 & OAMDATA \\ \hline
{\$}2005 & PPUSCROLL \\ \hline
{\$}2006 & PPUADDR \\ \hline
{\$}2007 & PPUDATA \\ \hline
{\$}4014 & OAMDMA \\ \hline
\end{tabular}
\end{table}
Nazw tych powszechnie u¿ywa siê w kodzie programów zamiast adresów bezpoœrednich oraz w dyskusjach na temat programowania konsol NES / Famicom. Tak¹ zasadê stosujê równie¿ w tym dokumencie.



\subsection{Rejestry kontroluj¹ce APU}
\label{cpuapuregisters}
Adresy {\$}4000 - {\$}4013, {\$}4015 oraz {\$}4017 w CPU maj¹ specjalne znaczenie - poprzez nie programista / program mo¿e wp³yn¹æ na dzia³anie uk³adu dŸwiêkowego konsoli. Zwyczajowe nazwy tych adresów przedstawia poni¿sza tabela \cite{wikicpuapuregisters}:
\begin{table}[H]
\begin{tabular}{|l|l|} \hline
Adres {hex} & Nazwa \\ \hline
{\$}4000 & PL1\_VOL \\ \hline
{\$}4001 & PL1\_SWEEP \\ \hline
{\$}4002 & PL1\_LO \\ \hline
{\$}4003 & PL1\_HI \\ \hline
{\$}4004 & PL2\_VOL \\ \hline
{\$}4005 & PL2\_SWEEP \\ \hline
{\$}4006 & PL2\_LO \\ \hline
{\$}4007 & PL2\_HI \\ \hline
{\$}4008 & TRI\_LINEAR \\ \hline
{\$}400A & TRI\_LO \\ \hline
{\$}400B & TRI\_HI \\ \hline
{\$}400C & NOISE\_VOL \\ \hline
{\$}400E & NOISE\_LO \\ \hline
{\$}400F & NOISE\_HI \\ \hline
{\$}400E & DMC\_FREQ \\ \hline
{\$}400F & DMC\_RAW \\ \hline
{\$}4010 & DMC\_START \\ \hline
{\$}4011 & DMC\_LEN \\ \hline
{\$}4012 & SND\_CHN \\ \hline
\end{tabular}
\end{table}
Nazwy te zosta³y zaczerpniête z biblioteki audio do NES / Famicom - FamiTone2 \cite{famitone2}. U¿ywam ich równie¿ w kodzie Ÿród³owym programu oraz w tym dokumencie.
(TODO: omówienie ka¿dego rejestru, jeszcze nie kodowa³em tego to nie znam szczegó³ów programowych)

\section{Projekt}
\label{project}
W tej sekcji omówiê krok po kroku jak powstawa³ mój w³asny projekt programu na platformê NES. Zacznê od pojedynczych, prostych czynnoœci a¿ po pewnego rodzaju pe³noprawny szkielet takiego projektu zgodny z dobrymi praktykami programowania NES. Nastêpnie zostan¹ omówione krytyczne fragmenty kodu z punktu widzenia ca³ego projektu oraz w³asne rozwi¹zania czêsto spotykanych zagadnieñ.

\setcounter{subsection}{-1}
\subsection{Przygotowania do projektu}
Dotychczas mia³em minimalne doœwiadczenie z programowaniem pod NES, przerobi³em popularny kurs traktuj¹cy o tym - Nerdy Nights \cite{nerdynights}, niestety z miernym zrozumieniem nie potrafi¹c zrobiæ czegoœ swojego. Problem by³ te¿ w dialekcie asemblera u¿ytego w tym kursie (NESASM3 \cite{nesasm}) o którym niewiele dyskutuje siê w sieci a nie widzia³em sensu w nauce kolejnej odmiany asemblera jak i tak za wiele nie umiem zaprogramowaæ, przez co w nastêpstwie temat umar³ - postanowi³em ¿e mo¿e kiedyœ do tego wrócê.

Tym razem mia³em zamiar zmodyfikowaæ podejœcie do tematu. Pierwsza sprawa to dog³êbnie poznaæ mo¿liwoœci u¿ywanych narzêdzi, w bardzo zaawansowanym stopniu opanowaæ narzêdzia wbudowane w emulator po to, aby umieæ ³atwo namierzaæ b³êdy oraz móc eksperymentowaæ - robi¹c modyfikacje w kodzie a nastêpnie obserwowaæ co siê zmieni³o, jak to dzia³a.
Kolejna rzecz to u¿yæ wiedzê programistyczn¹ zdobyt¹ od ostatniej próby nauki, ustanowiæ pewnego rodzaju dobre wzorce pisania kodu, podzieliæ projekt na pliki - poprzednio wszystko by³o w jednym, wielkim pliku Ÿród³owym. 

Nastêpna sprawa - dokumentacje, Ÿród³a wiedzy i tak dalej. Najobszerniejszym Ÿród³em wiedzy na temat NES jest strona nesdev - wiki \cite{wikinesdev} oraz forum \cite{forumnesdev}. Mocno techniczne Ÿród³a wiedzy, warto nadmieniæ, nie sposób zrozumieæ wszystko tak od razu ale wtedy zawsze mia³ ratowaæ mnie emulator z narzêdziami metod¹ prób i b³êdów. Podobna uwaga tyczy siê dialektu asemblera CA65 którego mia³em zamiar u¿ywaæ, dokumentacja projektu jest minimalna i ogólna. O tej decyzji zadecydowa³a jego popularnoœæ, mo¿liwe najszybsze uzyskania pomocy w razie problemów.

Generalnie mia³o byæ mo¿liwie najprofesjonalniej.

\subsection{Hello World}
Wiedz¹c ¿e jest perfekcyjnie opracowany kawa³ek kodu inicjuj¹cy konsolê do pe³ni poprawnego dzia³ania po prostu go skopiowa³em, zbudowa³em plik ROM a nastêpnie analizowa³em krok po kroku jak on dzia³a w emulatorze i co tam siê dziejê pod "mask¹" konsoli. Ten kod wygl¹da nastêpuj¹co:
\begin{verbatim}
reset:
    sei
    cld
    ldx #$40
    stx $4017
    ldx #$ff
    txs
    inx
    stx $2000
    stx $2001
    stx $4010

    bit $2002

@vblankwait1:  
    bit $2002
    bpl @vblankwait1

    txa
@clrmem:
    sta $000,x
    sta $100,x
    sta $200,x
    sta $300,x
    sta $400,x
    sta $500,x
    sta $600,x
    sta $700,x
    inx
    bne @clrmem
   
@vblankwait2:
    bit $2002
    bpl @vblankwait2
\end{verbatim}
Mia³em ju¿ wiedzê na temat najczêœciej u¿ywanych mnemoników typu \textit(lda / ldx, sta / stx, inx, txs, txa) gdy¿ by³y proste do zrozumienia, idea etykiet równie¿ by³a jasna, orientacja na temat instrukcji skoków warunkowych te¿ by³a ale szczegó³ów nie zna³em. Co do fragmentów kodu to czêœæ pod etykiet¹ \textit{@clrmem} by³a jasna - zerowanie ca³ego powierzchni RAM (adresy \$0000 - \$07FF). Pêtla koñczy³a siê gdy rejestr X siê "przekrêci³" na zero. Pêtle z etykietami \textit{vblankwait} by³y po to, ¿eby konsola mog³a poprawnie wyœwietlaæ grafikê. Mnemonik \textit{cld} wy³¹cza³ tryb dziesiêtny którego w sumie i tak nie ma w tej wersji procesora.

W celu zrozumienia ca³oœci w stu procentach zacz¹³em wertowaæ internet oraz debugowaæ ten kod.
Opkod \textit{sei} to instrukcja wy³¹czaj¹ca odnotowywanie przez CPU przerwañ niemaskowalnych. To znaczy ¿e procesor nie bêdzie reagowa³ na przerwania, dziêki czemu nie bêdzie zak³óca³ wykonania naszego kodu inicjuj¹cego. Przerwania nadal nadal siê "wewnêtrznie", cyklicznie wystêpuj¹!
Instrukcja \textit{cld} ma sens gdy¿ debuggery ogólnie dzia³aj¹ce na kodzie napisanym pod MOS 6502 (nie konkretnie pod NES) opieraj¹ siê na tym, i¿ ta konkretna flaga jest ustawiona.
Wartoœæ \#\$40 to w³aœciwie ustawienie bitu numer szeœæ. Ta wartoœæ jest wysy³ana pod port \$4017 CPU w celu wy³¹czenia przerwañ generowanych przez dodatkowe podzespo³y rozszerzaj¹ce mo¿liwoœci kartrid¿a.
Nastêpnie odbywa siê inicjacja stosu - wartoœæ \$FF jest ³adowana do rejestru X, mnemonik \textit{txs} kopiuje tê wartoœæ z rejestru X do rejestru wskaŸnika stosu. Proszê zauwa¿yæ ¿e to dolna czêœæ wskaŸnika stosu - górna jest ustawiona na wartoœæ \$01. Zatem w tym przypadku góra stosu to adres \$01FF.
Trzy kolejne zapisy wartoœci zero pod adresy \$2000, \$2001 oraz \$4010 to wy³¹czenie wszelkich flag którymi te trzy rejestry zarz¹dzaj¹. Najwa¿niejsze z nich to dezaktywacja \nameref{nmi} - znaczy to tyle ¿e przestanie wykonywaæ siê to przerwanie (rejestr \$2000), wy³¹czenie renderowania ekranu (\$2001), wy³¹czenie przerwania DMC którego dedykowanym zastosowaniem jest prawid³owe odgrywanie digitalizowanych próbek dŸwiêkowych (\$4010).

Z pêtlami \textit{vblankwait} sprawa okazuje siê bardziej skomplikowana. 
Trzeba odczekaæ dwie klatki obrazu aby uk³ad graficzny ustabilizowa³ siê oraz zacz¹³ pracowaæ w pe³ni prawid³owo \nameref{ppu} (TODO: dok³adne wskazanie omówienia co tam siê dzieje). Mamy wy³¹czone \nameref{nmi} ale jest jeszcze jedna metoda na odliczenie klatek obrazu. PPU zawsze sygnalizuje moment w którym zakoñczy³ rysowanie klatki obrazu (rozpocznie wygaszanie pionowe obrazu) poprzez ustawienie najwy¿szego bitu w rejestrze flag \$2002. A ten mo¿na sprawdziæ mnemonikiem \textit{bit}.
Opkod \textit{bit} ma specyficzne dzia³anie: wykonuje operacjê bitow¹ "akumulator AND operand instrukcji \textit{bit}", nastêpnie "zapomina" wynik za to ustawia flagê Z (flaga zero) jeœli wynik operacji AND by³ równy zero. Oprócz tego zawsze kopiuje bit szósty operandu do flagi V (flaga przepe³nienia), a siódmy do flagi N (flaga wartoœci ujemnej). W akumulatorze mamy w tej chwili wartoœæ zero - w jego przypadku akurat mamy gwarancjê ¿e po uruchomieniu konsoli / resecie zawsze bêdzie to wartoœæ zero a wczeœniej w kodzie nigdzie nie manipulowaliœmy tym rejestrem. Przyk³ad powinien rozjaœniæ:
\begin{verbatim}
W rejestrze A mamy wartoœæ zero.
Chcemy wykonaæ operacjê \textit{bit} na wartoœci #$80 (%10000000 binarnie).
Zatem wynik operacji:
    bit    #$80
bêdzie nastêpuj¹cy:
    %00000000
AND %10000000
    %00000000
\end{verbatim}
a w rezultacie:
\begin{enumerate}
\item flaga Z zostanie ustawiona,
\item flaga V zostanie wyzerowana,
\item flaga N zostanie ustawiona.
\end{enumerate}
Powy¿sze omówienie instrukcji \textit{bit} to sytuacja to¿sama z t¹, gdy w³aœnie PPU da³o znak ¿e skoñczy³o rysowaæ klatkê.
Instrukcja \textit{bpl} to jeden ze skoków warunkowych - dla \textit{bpl} skok do etykiety podanej jako operand ma miejsce, gdy flaga wartoœci ujemnej (V) jest wyzerowana.
Zatem program bêdzie "krêci³ siê w miejscu" dopóki flaga jest ujemna. Przestanie to robiæ gdy opkod \textit{bit} ustawi flagê N, a to siê stanie gdy PPU skoñczy rysowaæ klatkê oraz ustawi najwy¿szy bit w rejestrze \$2002. W ten sposób nale¿y rozumieæ zaprezentowany kod. Dzia³a to poprawnie tak¿e dlatego, i¿ po odczycie rejestru \$2002 najwy¿szy bit zostanie wyczyszczony, zatem nie ma mowy o sytuacji gdzie PPU ustawi³o tê flagê jakimœ cudem wczeœniej a teraz jest w trakcie rysowania kolejnej klatki.

Instrukcja \textit{bne} zamykaj¹ca pêtlê czyszcz¹c¹ RAM polega na fladze zero (Z). W przypadku tego skoku warunkowego skok ma miejsce gdy ta flaga jest wyzerowana / nieustawiona. Z tego wynika ¿e wykonanie zostanie przepuszczone za tê instrukcjê gdy flaga Z ustawi siê, a ustawi siê w momencie inkrementacji przekrêcaj¹c rejestr X (z wartoœci $FF na $00).

Pêtla \textit{vblankwait2} ma dzia³anie analogiczne do oczekiwania na pierwsze rozpoczêcie wygaszania obrazu.

Ten kod ju¿ wymaga³ bardzo du¿ej wiedzy ¿eby zrozumieæ co jak jest wykonane oraz czemu tak, a to nadal nie uruchomi siê nawet na emulatorze. W sekcji kodu potrzeba dodatkowych linii treœci a do tego warto jakoœ pokazaæ i¿ wszystko zosta³o zainicjowane poprawnie:
\begin{verbatim}
   lda	#%01100000
	sta	$2001
	
	lda #$16
	sta $0000
Stop:
	jmp Stop

.segment "VECTORS"
.word _INT_Reset
\end{verbatim}





\subsection{Drugi ekran z t³em, przewijanie ekranu}









\subsection{Podprogramy / procedury}







\subsection{Liczenie czasu}










\subsection{Animacja grafiki}







\subsection{Podzia³ projektu na pliki}










\subsection{Obs³uga kontrolera}
















\subsection{Implementacja trybów programu}









\section{Informacje o platformie}
\label{info}

\subsection{Zero Page}
\label{zeropage}

\subsection{NMI}
\label{nmi}

\subsection{PPU}
\label{ppu}

\subsection{Mapper}
\label{mapper}

\subsection{Pattern Table}
\label{patterntable}

\subsection{Nametable}
\label{nametable}

\subsection{Paleta barw}
\label{palette}

\section{Narzêdzia}
\subsection{CA65}
Strona projektu: https://cc65.github.io/
CA65 jest czêœci¹ wiêkszego pakietu zwanego CC65. Jest on zbiorem narzêdzi do kompilacji kodu napisanego w jêzyku C na sprzêty z procesorem MOS 6502. Za to CA65 jest asemblerem pod ten sam procesor.
W przypadku NES jêzyk C stanowi problem wydajnoœciowy, gdy¿ plik wynikowy który powstaje po kompilacji kodu w C jest znacznie wolniejszy ni¿ odpowiednik asemblerowy; warto pamiêtaæ i¿ ta konsola jest wielokrotnie mniej wydajna ni¿ wspó³czesne sprzêty. St¹d moja decyzja o pisaniu kodu tylko i wy³¹cznie w asemblerze.

(UWAGI: zestaw kompilator plus linker zas³uguje na wiêksze wyró¿nienie od ni¿ej opisanych programów pomocniczych do grafiki czy muzyki; do przemyœlenia miejsce w dokumencie)

\subsection{Mesen}
\label{emulator}
Emulator znacz¹co wspiera proces tworzenia oprogramowania pod NES, gdy¿ zawiera wiele narzêdzi pozwalaj¹cych na zbadanie zachowania naszego programu. Aby mieæ dostêp do narzêdzi deweloperskich, musimy w menu \textit{Options -> Preferences} zaznaczyæ checkbox "Enable developer mode". Od tej pory w menu jest widoczna nowa pozycja - \textit{debug}.

\begin{figure}[H]
    \includegraphics[width=\textwidth]{emulator1}
    \caption{Prze³¹cznik opcji deweloperskich w emulatorze Mesen.}
\end{figure}

\subsection{NES Screen Tool}
\begin{figure}[H]
\includegraphics[width=\textwidth]{nesst.png}
\caption{Ekran g³ówny aplikacji \cite{IMG-nesscreentooloverview}}
\label{fig:figure3}
\end{figure}
NES Screen Tool to program wspomagaj¹cy tworzenie grafiki zgodnej z platform¹ NES / Famicom. Aplikacja pozwala na szczegó³owe tworzenie grafik per pixel jak i bardziej ogólne dzia³ania jak eksport przygotowanych danych do formatu zrozumia³ego przez konsolê, gotowego do zastosowania w kodzie programu.
Strona domowa \cite{nesscreentoolpage}.

\subsection{FamiTracker}
\begin{figure}[H]
\includegraphics[width=\textwidth]{famitracker.png}
\caption{Ekran g³ówny aplikacji \cite{IMG-famitrackeroverview}}
\label{fig:figure3}
\end{figure}
FamiTracker to program pozwalaj¹cy na tworzenie muzyki w stu procentach kompatybilnej z platformami NES / Famicom. Aplikacja nale¿y do rodziny trackerów - programów komputerowych w których komponuje siê muzykê wykorzystuj¹c po³¹czenie zapisu nutowego oraz poleceñ steruj¹cych efektami \cite{wikitracker}.
Strona domowa \cite{famitrackerpage}.

\begin{thebibliography}{99}
\bibitem{IMG-NintendoFamicomConsoleSetFL}
https://upload.wikimedia.org/wikipedia/commons/0/06/Nintendo-Famicom-Console-Set-FL.jpg
\bibitem{IMG-NESConsoleSet} https://upload.wikimedia.org/wikipedia/commons/8/82/NES-Console-Set.jpg
\bibitem{IMG-NewFamicom}
https://upload.wikimedia.org/wikipedia/commons/f/f1/New\_Famicom.jpg
\bibitem{IMG-NES101ConsoleSet}
https://upload.wikimedia.org/wikipedia/commons/e/e0/NES-101-Console-Set.jpg
\bibitem{IMG-GenerationNEX}
https://levelupvideogames.com/used-messiah-generation-nex-468309594161/
\bibitem{IMG-DaryarDY400656}
http://forum.pegasus-gry.com/index.php?topic=2315.0
\bibitem{IMG-GLK-2004}
https://arhn.eu/2018/04/historia-pegasusa-z-klawiatura-glk-2004-et-al/
\bibitem{IMG-Game-Axe-Color}
https://www.ign.com/articles/2000/06/10/game-axe-color
\bibitem{IMG-RetroUSBAVS}
https://upload.wikimedia.org/wikipedia/commons/7/7a/RetroUSB-AVS-Console-wController-FL.jpg
\bibitem{IMG-RetroN5}
https://cdn10.bigcommerce.com/s-2l8ru96d/products/223/images/1135/ret5bk\_\_54484.1567795736.1280.1280.jpg?c=2
\bibitem{IMG-620Games}
https://www.amazon.com/Controllers-Children-Birthday-Childhood-Memories/dp/B083RBYRYN
\bibitem{IMG-mgiq502} http://www.retrogamingmuseum.com/the-collection/micro-genius-nes-clone
\bibitem{IMG-pegiq502} https://archiwum.allegro.pl/oferta/konsola-pegasus-iq-502-pady-pudelko-plomba-i7530854084.html
\bibitem{IMG-deniq502} https://youla.ru/moskva/hobbi-razvlecheniya/konsoli-igry/dendy-classic-2-novaia-5b6c9ae1cf689a85567f44a6
\bibitem{wikinesdev} http://wiki.nesdev.com/w/index.php/Nesdev\_Wiki
\bibitem{forumnesdev} http://forums.nesdev.com/
\bibitem{wikiNES}
https://en.wikipedia.org/wiki/Nintendo\_Entertainment\_System
\bibitem{wikiNESClones}
https://en.wikipedia.org/wiki/Nintendo\_Entertainment\_System\_hardware\_clone
\bibitem{nesdoc} Patrick Diskin: \emph{Nintendo Entertainment System Documentation}, 2.1 2A03 Overview, http://www.nesdev.com/NESDoc.pdf
\bibitem{nesmemorymap} http://wiki.nesdev.com/w/index.php/CPU\_memory\_map
\bibitem{wikicpuppuregisters} http://wiki.nesdev.com/w/index.php/PPU\_registers\#Summary
\bibitem{wikicpuapuregisters} http://wiki.nesdev.com/w/index.php/APU\#Specification
\bibitem{famitone2} http://forums.nesdev.com/viewtopic.php?t=7329
\bibitem{nesscreentoolpage} https://shiru.untergrund.net/software.shtml
\bibitem{IMG-nesscreentooloverview} https://shiru.untergrund.net/pic/nesst.png
\bibitem{famitrackerpage} http://famitracker.com/
\bibitem{IMG-famitrackeroverview} https://blog.uptodown.com/wp-content/uploads/Famitracker-pianola.jpg.webp
\bibitem{wikitracker} https://pl.wikipedia.org/wiki/Tracker\_(oprogramowanie\_muzyczne)
\bibitem{initcode} http://wiki.nesdev.com/w/index.php/Init\_code
\bibitem{IMG-nescolors} http://wiki.nesdev.com/w/index.php/File:Savtool-swatches.png
\bibitem{nerdynights} https://nerdy-nights.nes.science/
\bibitem{nesasm} http://www.nespowerpak.com/nesasm/
\end{thebibliography}

\end{document}
